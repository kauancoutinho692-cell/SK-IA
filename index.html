# ============================================================
# IA AGENTE ULTRA++ ‚Äî VERS√ÉO APLICATIVO WEB (FLASK)
# ============================================================

import sqlite3
import datetime
import uuid
import random
from flask import Flask, request, jsonify

# ============================================================
# APP
# ============================================================

app = Flask(__name__)

# ============================================================
# UTILIDADES
# ============================================================

def now():
    return datetime.datetime.now().strftime("%d/%m/%Y %H:%M:%S")

# ============================================================
# BANCO DE DADOS
# ============================================================

db = sqlite3.connect("ia_ultra_plus.db", check_same_thread=False)
c = db.cursor()

c.execute("""
CREATE TABLE IF NOT EXISTS leads (
    id TEXT PRIMARY KEY,
    score INTEGER,
    nivel TEXT,
    personalidade TEXT,
    ultima_interacao TEXT
)
""")

c.execute("""
CREATE TABLE IF NOT EXISTS logs (
    id TEXT,
    role TEXT,
    message TEXT,
    data TEXT
)
""")

db.commit()

# ============================================================
# PRODUTOS
# ============================================================

PRODUCTS = {
    "basico": {"nome": "Guia Do Zero ao Primeiro Pix", "preco": 5.99},
    "premium": {"nome": "Projeto Renda Digital + IA", "preco": 15.00}
}

# ============================================================
# ANALISADORES
# ============================================================

def detect_intent(text):
    t = text.lower()
    if any(x in t for x in ["pre√ßo", "valor", "quanto"]): return "PRICE"
    if any(x in t for x in ["funciona", "vale", "confio"]): return "DOUBT"
    if any(x in t for x in ["comprar", "pix", "quero"]): return "BUY"
    if any(x in t for x in ["depois", "agora n√£o"]): return "BLOCK"
    return "CHAT"

def detect_personality(text):
    t = text.lower()
    if any(x in t for x in ["medo", "desconfiado"]): return "cauteloso"
    if any(x in t for x in ["r√°pido", "direto"]): return "direto"
    return "normal"

# ============================================================
# LEAD SCORING
# ============================================================

def lead_score(intent_type):
    scores = {"BUY": 30, "PRICE": 20, "DOUBT": 10, "CHAT": 5, "BLOCK": 2}
    return scores.get(intent_type, 0)

# ============================================================
# AGENTES
# ============================================================

class SalesAgent:
    def respond(self, intent_type):
        if intent_type == "PRICE":
            return "Tenho duas op√ß√µes: R$5,99 pra come√ßar ou R$15,00 com IA inclusa."
        if intent_type == "DOUBT":
            return "Funciona pra quem aplica. O foco √© simplicidade."
        if intent_type == "BUY":
            return "Perfeito. Te mando o link agora?"
        if intent_type == "BLOCK":
            return "Entendo. Mas continuar parado costuma custar mais."
        return "Me conta: o que mais te trava hoje?"

# ============================================================
# IA PRINCIPAL
# ============================================================

class IAUltraPlus:
    def __init__(self):
        self.id = str(uuid.uuid4())
        self.score = 0
        self.sales = SalesAgent()

        c.execute("""
        INSERT OR IGNORE INTO leads VALUES (?, ?, ?, ?, ?)
        """, (self.id, 0, "iniciante", "normal", now()))
        db.commit()

    def log(self, role, msg):
        c.execute("INSERT INTO logs VALUES (?, ?, ?, ?)",
                  (self.id, role, msg, now()))
        db.commit()

    def handle(self, msg):
        self.log("user", msg)

        intent_type = detect_intent(msg)
        perfil = detect_personality(msg)
        self.score += lead_score(intent_type)

        c.execute("""
        UPDATE leads SET score=?, personalidade=?, ultima_interacao=?
        WHERE id=?
        """, (self.score, perfil, now(), self.id))
        db.commit()

        resposta = self.sales.respond(intent_type)
        self.log("agent", resposta)
        return resposta

ia = IAUltraPlus()

# ============================================================
# ROTAS
# ============================================================

@app.route("/")
def home():
    return "IA ULTRA++ ONLINE üöÄ"

@app.route("/chat", methods=["POST"])
def chat():
    data = request.json
    mensagem = data.get("message", "")
    resposta = ia.handle(mensagem)
    return jsonify({"resposta": resposta})

# ============================================================
# RUN
# ============================================================

app.run(host="0.0.0.0", port=3000)
